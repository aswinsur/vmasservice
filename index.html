<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>VM Deployment Request</title>
<style>
  body { font-family: Arial, sans-serif; margin: 40px; background: #f7f9fc; }
  form { max-width:700px; margin:auto; background:#fff; padding:20px; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.1); }
  label{display:block;margin-top:12px;font-weight:600}
  input,select{width:100%;padding:8px;margin-top:6px;border:1px solid #ccc;border-radius:6px}
  button{margin-top:18px;background:#0078d4;color:#fff;border:none;padding:10px;border-radius:6px;cursor:pointer}
  .small{font-size:0.9rem;color:#666}
</style>
</head>
<body>
<h1 style="text-align:center;color:#333">VM Deployment Request</h1>

<form id="vmForm">
  <label>Subscription</label>
  <select id="subscription_id" required>
    <option value="">Loading...</option>
  </select>

  <label>Resource Group</label>
  <select id="resource_group" required><option value="">Select subscription first</option></select>

  <label>VNet</label>
  <select id="vnet" required><option value="">Select resource group first</option></select>

  <label>Region</label>
  <select id="region" required>
    <option value="">Select Region</option>
    <option value="East US">East US</option>
    <option value="Central India">Central India</option>
    <option value="West Europe">West Europe</option>
  </select>

  <label>VM Size</label>
  <select id="vm_size" required>
    <option value="">Select size</option>
    <option value="Standard_DS1_v2">Standard_DS1_v2</option>
    <option value="Standard_DS2_v2">Standard_DS2_v2</option>
    <option value="Standard_B2s">Standard_B2s</option>
  </select>

  <label>VM Name</label>
  <input id="vm_name" required />

  <label>Username</label>
  <input id="username" required />

  <label>Password</label>
  <input id="password" type="password" required />

  <div style="display:flex;gap:8px">
    <button id="checkBtn" type="button">Check & Submit</button>
  </div>

  <p id="msg" class="small"></p>
</form>

<script>
const LOGIC_BASE = {
  subs: "https://<YOUR_LOGIC_APP_BASE>/triggers/GetSubscriptions/paths/invoke",
  rgs: "https://<YOUR_LOGIC_APP_BASE>/triggers/GetResourceGroups/paths/invoke",
  vnets: "https://<YOUR_LOGIC_APP_BASE>/triggers/GetVNets/paths/invoke",
  submit: "https://<YOUR_LOGIC_APP_BASE>/triggers/SubmitVMRequest/paths/invoke"
};
// Replace <YOUR_LOGIC_APP_BASE> with the host + path provided by the Logic App (the same format you used earlier).
// If your Logic App triggers require query params (api-version & sig), append them like ?api-version=...&sig=...

const el = id => document.getElementById(id);
const msg = el('msg');

async function loadSubscriptions() {
  try {
    const res = await fetch(LOGIC_BASE.subs, { method: 'GET' });
    const body = await res.json();
    // body.value expected to be array of subscriptions
    const subs = body.value || body;
    const sel = el('subscription_id');
    sel.innerHTML = '<option value="">Select Subscription</option>';
    subs.forEach(s => {
      const id = s.subscriptionId || s.subscription_id || s.id || s.name;
      const title = s.displayName || s.name || id;
      const opt = document.createElement('option');
      opt.value = id.replace('/subscriptions/','') || id;
      opt.text = title + (id ? (' — ' + (s.subscriptionId || id)) : '');
      sel.appendChild(opt);
    });
  } catch (e) {
    msg.textContent = 'Error loading subscriptions: ' + e;
  }
}

async function loadResourceGroups(subscriptionId) {
  try {
    const res = await fetch(LOGIC_BASE.rgs + '?subscription_id=' + encodeURIComponent(subscriptionId), { method: 'GET' });
    const body = await res.json();
    const groups = body.value || body;
    const sel = el('resource_group');
    sel.innerHTML = '<option value="">Select Resource Group</option>';
    groups.forEach(g => {
      const opt = document.createElement('option');
      opt.value = g.name;
      opt.text = g.name;
      sel.appendChild(opt);
    });
  } catch (e) {
    msg.textContent = 'Error loading resource groups: ' + e;
  }
}

async function loadVnets(subscriptionId, rg) {
  try {
    const res = await fetch(LOGIC_BASE.vnets + '?subscription_id=' + encodeURIComponent(subscriptionId) + '&resource_group=' + encodeURIComponent(rg), { method: 'GET' });
    const body = await res.json();
    const nets = body.value || body;
    const sel = el('vnet'); sel.innerHTML = '<option value="">Select VNet</option>';
    nets.forEach(n => {
      const opt = document.createElement('option'); opt.value = n.name; opt.text = n.name; sel.appendChild(opt);
    });
  } catch (e) {
    msg.textContent = 'Error loading VNets: ' + e;
  }
}

el('subscription_id').addEventListener('change', e => {
  const sub = e.target.value;
  if (sub) { loadResourceGroups(sub); } else { el('resource_group').innerHTML = '<option value="">Select subscription first</option>'; el('vnet').innerHTML = '<option value="">Select resource group first</option>'; }
});
el('resource_group').addEventListener('change', e => {
  const sub = el('subscription_id').value;
  const rg = e.target.value;
  if (sub && rg) loadVnets(sub, rg);
});

el('checkBtn').addEventListener('click', async () => {
  msg.textContent = '';
  const data = {
    subscription_id: el('subscription_id').value,
    resource_group: el('resource_group').value,
    vnet: el('vnet').value,
    region: el('region').value,
    vm_size: el('vm_size').value,
    vm_name: el('vm_name').value,
    username: el('username').value,
    password: el('password').value
  };
  // basic validation
  for (const k of ['subscription_id','resource_group','vnet','region','vm_size','vm_name','username','password']) {
    if (!data[k]) { msg.textContent = 'Please fill ' + k; return; }
  }

  // Call the SubmitVMRequest endpoint — Logic App will check VM existence and either return error or send approval & trigger pipeline
  try {
    const res = await fetch(LOGIC_BASE.submit, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    const body = await res.json();
    if (!res.ok) {
      msg.textContent = 'Error: ' + (body.error || JSON.stringify(body));
    } else {
      msg.textContent = 'Request accepted: ' + (body.message || 'Approval sent (check email).');
      document.getElementById('vmForm').reset();
    }
  } catch (e) {
    msg.textContent = 'Submit error: ' + e;
  }
});

// load subscriptions on page load
loadSubscriptions();
</script>
</body>
</html>
