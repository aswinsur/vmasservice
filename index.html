<!DOCTYPE html>
<html>
<head>
    <title>VM Deployment Request</title>
    <style>
        label { display: block; margin-top: 10px; }
        select, input { width: 300px; padding: 5px; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>

<h2>VM Deployment Request</h2>

<form id="vmForm">
    <!-- Subscription -->
    <label for="subscription">Subscription:</label>
    <select id="subscription" name="subscription" required></select>

    <!-- Resource Group -->
    <label for="resourceGroup">Resource Group:</label>
    <select id="resourceGroup" name="resourceGroup" required></select>

    <!-- VNet -->
    <label for="vnet">Virtual Network:</label>
    <select id="vnet" name="vnet" required></select>

    <!-- VM Name -->
    <label for="vmName">VM Name:</label>
    <input type="text" id="vmName" name="vmName" required>
    <div id="vmStatus"></div>

    <br><br>
    <button type="submit">Deploy VM</button>
</form>

<script>
async function apiFetch(url) {
    const res = await fetch(url);
    return await res.json();
}

async function loadSubscriptions() {
    const data = await apiFetch('/api/getSubscriptions');
    const subSelect = document.getElementById('subscription');
    subSelect.innerHTML = '<option value="">Select Subscription</option>';
    data.forEach(sub => {
        let opt = document.createElement('option');
        opt.value = sub.id;
        opt.textContent = sub.name;
        subSelect.appendChild(opt);
    });
}

async function loadResourceGroups(subscriptionId) {
    const data = await apiFetch(`/api/getResourceGroups?subscriptionId=${subscriptionId}`);
    const rgSelect = document.getElementById('resourceGroup');
    rgSelect.innerHTML = '<option value="">Select Resource Group</option>';
    data.forEach(rg => {
        let opt = document.createElement('option');
        opt.value = rg.name;
        opt.textContent = rg.name;
        rgSelect.appendChild(opt);
    });
}

async function loadVNets(subscriptionId, resourceGroup) {
    const data = await apiFetch(`/api/getVNets?subscriptionId=${subscriptionId}&resourceGroup=${resourceGroup}`);
    const vnetSelect = document.getElementById('vnet');
    vnetSelect.innerHTML = '<option value="">Select VNet</option>';
    data.forEach(vnet => {
        let opt = document.createElement('option');
        opt.value = vnet.name;
        opt.textContent = vnet.name;
        vnetSelect.appendChild(opt);
    });
}

async function checkVMName(subscriptionId, resourceGroup, vmName) {
    if (!subscriptionId || !resourceGroup || !vmName) return;
    const statusDiv = document.getElementById('vmStatus');
    statusDiv.textContent = "Checking availability...";
    const result = await apiFetch(`/api/checkVMName?subscriptionId=${subscriptionId}&resourceGroup=${resourceGroup}&vmName=${vmName}`);
    if (result.exists) {
        statusDiv.innerHTML = `<span class="error">❌ VM name already exists!</span>`;
        return false;
    } else {
        statusDiv.innerHTML = `<span class="success">✅ VM name is available</span>`;
        return true;
    }
}

document.getElementById('subscription').addEventListener('change', (e) => {
    loadResourceGroups(e.target.value);
});

document.getElementById('resourceGroup').addEventListener('change', (e) => {
    const subscriptionId = document.getElementById('subscription').value;
    loadVNets(subscriptionId, e.target.value);
});

document.getElementById('vmName').addEventListener('blur', () => {
    const sub = document.getElementById('subscription').value;
    const rg = document.getElementById('resourceGroup').value;
    const vmName = document.getElementById('vmName').value;
    checkVMName(sub, rg, vmName);
});

window.onload = loadSubscriptions;
</script>

</body>
</html>
